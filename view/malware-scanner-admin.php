<?php
/**
 * Malware Scanner View
 */
?>

<div class="md3-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <div>
            <h2 class="md3-card-title">Malware Scanner</h2>
            <p class="md3-card-subtitle">Scan your WordPress files for suspicious patterns</p>
        </div>
        <div>
            <button class="md3-button md3-button-filled" onclick="startScan()" id="scan-btn">
                <span class="material-symbols-outlined"
                    style="margin-right: 8px; vertical-align: middle;">security</span>
                Start Scan
            </button>
        </div>
    </div>

    <div id="scan-progress" style="display: none; text-align: center; padding: 48px;">
        <div class="md3-circular-progress"></div>
        <p style="margin-top: 16px; color: var(--md-sys-color-on-surface-variant);">Scanning... This may take a while.
        </p>
    </div>

    <div id="scan-results" style="display: none;">
        <div class="md3-table-container">
            <table class="md3-table">
                <thead>
                    <tr>
                        <th>File</th>
                        <th>Severity</th>
                        <th>Signature</th>
                        <th>Line</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="results-body">
                </tbody>
            </table>
        </div>
        <div id="no-results"
            style="display: none; text-align: center; padding: 48px; color: var(--md-sys-color-on-surface-variant);">
            <span class="material-symbols-outlined"
                style="font-size: 48px; margin-bottom: 16px; display: block;">check_circle</span>
            <p>No suspicious files found!</p>
        </div>
    </div>
</div>

<script>
    function startScan() {
        const btn = document.getElementById('scan-btn');
        const progress = document.getElementById('scan-progress');
        const results = document.getElementById('scan-results');
        const noResults = document.getElementById('no-results');
        const tbody = document.getElementById('results-body');

        btn.disabled = true;
        progress.style.display = 'block';
        results.style.display = 'none';

        WPSafeMode.API.get('/api/malware-scanner?action=scan')
            .then(response => {
                progress.style.display = 'none';
                btn.disabled = false;

                if (response.success) {
                    results.style.display = 'block';
                    tbody.innerHTML = '';

                    if (response.data.results.length === 0) {
                        noResults.style.display = 'block';
                        results.querySelector('table').style.display = 'none';
                    } else {
                        noResults.style.display = 'none';
                        results.querySelector('table').style.display = 'table';

                        response.data.results.forEach(file => {
                            file.matches.forEach(match => {
                                const row = document.createElement('tr');

                                let severityColor = 'var(--md-sys-color-primary)';
                                if (match.severity === 'critical') severityColor = 'var(--md-sys-color-error)';
                                if (match.severity === 'warning') severityColor = 'var(--md-sys-color-tertiary)';

                                row.innerHTML = `
                                    <td><div style="word-break: break-all;">${WPSafeMode.Utils.escapeHtml(file.file)}</div></td>
                                    <td><span class="badge" style="background-color: ${severityColor}; color: white;">${match.severity.toUpperCase()}</span></td>
                                    <td>${WPSafeMode.Utils.escapeHtml(match.description)}</td>
                                    <td>${match.line}</td>
                                    <td>
                                        <a href="?view=file-manager&path=${encodeURIComponent(file.file)}" class="md3-button md3-button-text" target="_blank">View</a>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                        });
                    }
                } else {
                    alert('Scan failed: ' + response.message);
                }
            })
            .catch(error => {
                progress.style.display = 'none';
                btn.disabled = false;
                alert('Scan error: ' + error.message);
            });
    }
</script>